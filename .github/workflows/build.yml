name: Publish APT Repo

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages
          git checkout gh-pages

      - name: Copy .deb from release
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*.deb"

      - name: Move package to repo
        run: |
          mkdir -p debian/dists/stable/main/binary-amd64
          mv *.deb debian/dists/stable/main/binary-amd64/

      - name: Generate Packages.gz
        run: |
          cd debian/dists/stable/main/binary-amd64
          dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
          dpkg-scanpackages . /dev/null > Packages

      - name: Commit and push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add .
          git commit -m "Update repo for ${{ github.event.release.tag_name }}"
          git push origin gh-pages
